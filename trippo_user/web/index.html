<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Buckley Transport">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Buckley Transport</title>
  <link rel="manifest" href="manifest.json">

  <!-- Google Maps JavaScript API - MUST load BEFORE Flutter for web platform -->
  <!-- According to: https://developers.google.com/maps/flutter-package/config -->
  <!-- This is required for google_maps_flutter_web to work correctly -->
  <script>
    // Define callback BEFORE loading the script
    window.googleMapsLoaded = function() {
      window.googleMapsReady = true;
      console.log('‚úÖ Google Maps API callback triggered');
      
      // Wait a moment for libraries to fully initialize
      setTimeout(function() {
        if (window.google && window.google.maps) {
          console.log('‚úÖ Google Maps object available');
          console.log('   Places:', !!window.google.maps.places);
          console.log('   DirectionsService:', !!window.google.maps.DirectionsService);
          console.log('   Geocoder:', !!window.google.maps.Geocoder);
          console.log('   LatLng:', !!window.google.maps.LatLng);
        } else {
          console.error('‚ùå Google Maps object not found after callback');
        }
      }, 100);
    };
    
    // Error handler if script fails to load
    window.googleMapsError = function() {
      console.error('‚ùå Google Maps API script failed to load');
      window.googleMapsReady = false;
    };
  </script>
  <!-- Load Google Maps API WITHOUT defer/async - must load synchronously -->
  <!-- Add error handler and ensure script loads before Flutter -->
  <script 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnsK0I2lw7YP3qhUthMBtlsiJ31WVkPrY&libraries=places,geometry,drawing&callback=googleMapsLoaded"
    onerror="window.googleMapsError()">
  </script>

  <!-- Stripe.js for web payment processing -->
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // Initialize Stripe on web
    var stripePublishableKey = 'pk_test_51SIvJVDjdHHArGB1gce3Dt39aBAZJSdERnMCLeF8VeYMzNNLpGRAW1M4ommB94O75CM65JKLVulbBATONp6ybzgM00tvHvblxc';
    var stripe = null;
    var cardElement = null;
    var elements = null;
    
    // Initialize Stripe when script loads
    if (typeof Stripe !== 'undefined') {
      stripe = new Stripe(stripePublishableKey);
      console.log('‚úÖ Stripe.js loaded successfully');
    } else {
      console.error('‚ùå Stripe.js failed to load');
    }
    
    // Create Stripe Elements card element
    window.initializeStripeElements = function(containerElementId) {
      try {
        if (!stripe) {
          throw new Error('Stripe not initialized');
        }
        
        console.log('üé® Initializing Stripe Elements...');
        
        // Create Elements instance
        elements = stripe.elements();
        
        // Create card element with styling
        cardElement = elements.create('card', {
          style: {
            base: {
              color: '#ffffff',
              fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
              fontSmoothing: 'antialiased',
              fontSize: '16px',
              '::placeholder': {
                color: '#9e9e9e',
              },
            },
            invalid: {
              color: '#fa755a',
              iconColor: '#fa755a',
            },
          },
        });
        
        // Mount to container
        const container = document.getElementById(containerElementId);
        if (container) {
          cardElement.mount('#' + containerElementId);
          console.log('‚úÖ Stripe Elements mounted to:', containerElementId);
        } else {
          console.error('‚ùå Container element not found:', containerElementId);
        }
        
        return true;
      } catch (error) {
        console.error('‚ùå Failed to initialize Stripe Elements:', error);
        return false;
      }
    };
    
    // Create payment method using Stripe Elements
    // This is the REQUIRED approach for web PCI compliance
    window.createStripePaymentMethod = async function(cardholderName) {
      try {
        if (!stripe || !cardElement) {
          throw new Error('Stripe or card element not initialized');
        }
        
        console.log('Creating payment method with Stripe Elements...');
        console.log('  Cardholder:', cardholderName);
        
        // Create payment method using card element (NOT raw card data)
        const result = await stripe.createPaymentMethod({
          type: 'card',
          card: cardElement,  // ‚Üê Uses card element, not raw data
          billing_details: {
            name: cardholderName,
          },
        });
        
        if (result.error) {
          console.error('‚ùå Payment method creation error:', result.error);
          throw new Error(result.error.message);
        }
        
        console.log('‚úÖ Payment method created:', result.paymentMethod.id);
        console.log('   Card:', result.paymentMethod.card.brand, '‚Ä¢‚Ä¢‚Ä¢‚Ä¢', result.paymentMethod.card.last4);
        
        // Return payment method ID
        return {
          success: true,
          paymentMethodId: result.paymentMethod.id,
          last4: result.paymentMethod.card.last4,
          brand: result.paymentMethod.card.brand,
          expMonth: result.paymentMethod.card.exp_month,
          expYear: result.paymentMethod.card.exp_year,
        };
      } catch (error) {
        console.error('‚ùå Stripe payment method creation failed:', error);
        return {
          success: false,
          error: error.message || 'Failed to create payment method',
        };
      }
    };
    
    // Mark Stripe as ready
    window.stripeReady = true;
    console.log('‚úÖ Stripe payment functions ready');
  </script>

  <script>
    // The value below is injected by flutter build, do not touch.
    var serviceWorkerVersion = {{flutter_service_worker_version}};
  </script>
  <!-- This script adds the flutter initialization JS code -->
  <!-- Note: Flutter script CAN be deferred since Google Maps loads first -->
  <script src="flutter.js" defer></script>
  <script>
    // Ensure Google Maps API is loaded before Flutter initializes
    function waitForGoogleMaps(callback, maxAttempts) {
      maxAttempts = maxAttempts || 100; // Default 10 seconds
      
      if (window.google && window.google.maps && window.google.maps.places) {
        console.log('Google Maps API loaded successfully');
        callback();
      } else if (maxAttempts > 0) {
        setTimeout(function() {
          waitForGoogleMaps(callback, maxAttempts - 1);
        }, 100);
      } else {
        console.error('Google Maps API failed to load after 10 seconds');
        // Still proceed with Flutter initialization
        callback();
      }
    }
    
    // Check immediately if Google Maps is already loaded (script might have loaded before this code runs)
    function checkGoogleMapsImmediate() {
      var hasGoogle = typeof window.google !== 'undefined';
      var hasMaps = hasGoogle && typeof window.google.maps !== 'undefined';
      var hasCallback = window.googleMapsReady === true;
      
      if (hasGoogle && hasMaps && hasCallback) {
        console.log('‚úÖ Google Maps already loaded before Flutter initialization');
        return true;
      }
      return false;
    }
    
    window.addEventListener('load', function(ev) {
      // For Flutter Web with google_maps_flutter, we need Google Maps API loaded first
      // Check if Google Maps is ready, wait if needed (but don't block too long)
      var attempts = 0;
      var maxAttempts = 100; // 10 seconds max wait (increased from 5)
      
      function initializeFlutter() {
        console.log('üöÄ Initializing Flutter...');
        _flutter.loader.loadEntrypoint({
          serviceWorker: {
            serviceWorkerVersion: serviceWorkerVersion,
          }
        }).then(function(engineInitializer) {
          return engineInitializer.initializeEngine();
        }).then(function(appRunner) {
          return appRunner.runApp();
        }).catch(function(error) {
          console.error('Failed to initialize Flutter:', error);
        });
      }
      
      function checkAndInitialize() {
        var mapsReady = window.googleMapsReady === true;
        var hasGoogle = typeof window.google !== 'undefined';
        var hasMaps = hasGoogle && typeof window.google.maps !== 'undefined';
        var hasPlaces = hasMaps && typeof window.google.maps.places !== 'undefined';
        var hasDirections = hasMaps && typeof window.google.maps.DirectionsService !== 'undefined';
        var hasGeocoder = hasMaps && typeof window.google.maps.Geocoder !== 'undefined';
        var hasLatLng = hasMaps && typeof window.google.maps.LatLng !== 'undefined';
        
        if (mapsReady && hasGoogle && hasMaps && hasPlaces && hasDirections && hasGeocoder && hasLatLng) {
          console.log('‚úÖ Google Maps API confirmed ready with ALL libraries');
          console.log('   ‚úì Places, ‚úì DirectionsService, ‚úì Geocoder, ‚úì LatLng');
          initializeFlutter();
        } else if (attempts < maxAttempts) {
          attempts++;
          if (attempts % 10 === 0) {
            console.log('‚è≥ Waiting for Google Maps... (attempt ' + attempts + '/' + maxAttempts + ')', {
              callback: mapsReady,
              google: hasGoogle,
              maps: hasMaps,
              places: hasPlaces,
              directions: hasDirections,
              geocoder: hasGeocoder,
              latLng: hasLatLng
            });
          }
          setTimeout(checkAndInitialize, 100);
        } else {
          console.error('‚ùå Google Maps API not fully ready after 10 seconds');
          console.error('   Final Status:', {
            callback: mapsReady,
            google: hasGoogle,
            maps: hasMaps,
            places: hasPlaces,
            directions: hasDirections,
            geocoder: hasGeocoder,
            latLng: hasLatLng
          });
          console.error('   Check browser Network tab for script loading errors');
          console.error('   Initializing Flutter anyway - app will retry when needed');
          // Initialize anyway - the google_places_web.dart code will handle retries
          initializeFlutter();
        }
      }
      
      // Check if already loaded
      if (checkGoogleMapsImmediate()) {
        initializeFlutter();
      } else {
        // Start checking
        checkAndInitialize();
      }
    });
  </script>
</head>
<body>
</body>
</html>
